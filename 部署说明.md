# 🚀 部署说明 README

本项目支持两种部署方式：**GitHub Actions 自动部署**和**手动部署**。

---

## 📚 文档导航

- **[DEPLOYMENT.md](./DEPLOYMENT.md)** - 完整部署指南（推荐阅读）
- **[nginx.conf](./nginx.conf)** - Nginx 配置文件
- **[.github/workflows/deploy.yml](./.github/workflows/deploy.yml)** - GitHub Actions 工作流
- **[deploy.sh](./deploy.sh)** - 手动部署脚本

---

## 🎯 快速选择部署方式

### 方式一：GitHub Actions 自动部署（推荐）

**优势**：
- ✅ 自动化，每次 push 代码自动部署
- ✅ 无需本地构建，节省时间
- ✅ 部署历史可追踪
- ✅ 支持回滚

**适合场景**：
- 团队协作开发
- 需要频繁更新的项目
- 想要自动化工作流

**快速开始**：
1. 阅读 [DEPLOYMENT.md](./DEPLOYMENT.md) 的"GitHub Actions 配置"章节
2. 在服务器上安装 Nginx
3. 在 GitHub 仓库设置 Secrets
4. Push 代码，自动部署！

### 方式二：手动部署

**优势**：
- ✅ 更灵活的控制
- ✅ 不依赖 GitHub Actions
- ✅ 适合一次性部署

**适合场景**：
- 个人项目
- 不常更新的项目
- 内网环境

**快速开始**：
```bash
# 1. 修改 deploy.sh 中的配置
nano deploy.sh

# 2. 运行部署脚本
./deploy.sh
```

---

## 📋 部署前准备清单

### 服务器端

- [ ] **安装 Nginx**
  ```bash
  sudo apt install nginx -y
  ```

- [ ] **创建部署目录**
  ```bash
  sudo mkdir -p /var/www/mini-social-media/dist
  sudo chown -R $USER:$USER /var/www/mini-social-media
  ```

- [ ] **配置 Nginx**
  - 复制 `nginx.conf` 内容
  - 修改 `server_name` 为你的域名
  - 启用配置：`sudo ln -s /etc/nginx/sites-available/mini-social-media /etc/nginx/sites-enabled/`
  - **删除默认站点**：`sudo rm /etc/nginx/sites-enabled/default`

- [ ] **开放防火墙端口**
  ```bash
  sudo ufw allow 'Nginx Full'
  sudo ufw allow OpenSSH
  ```

### GitHub 端（仅 GitHub Actions 需要）

- [ ] **设置 Secrets**
  - `SERVER_HOST` - 服务器 IP
  - `SERVER_USERNAME` - SSH 用户名
  - `SERVER_SSH_KEY` - SSH 私钥
  - `SERVER_PORT` - SSH 端口（通常是 22）
  - `DEPLOY_PATH` - 部署路径

### 域名配置

- [ ] **DNS 解析**
  - 添加 A 记录指向服务器 IP
  - 等待 DNS 生效（可能需要几分钟到几小时）

- [ ] **SSL 证书**（可选但推荐）
  ```bash
  sudo certbot --nginx -d your-domain.com
  ```

---

## 🔄 部署流程对比

### GitHub Actions 自动部署流程

```
本地修改代码
    ↓
git push origin main
    ↓
GitHub Actions 自动触发
    ↓
自动构建项目（npm run build）
    ↓
自动上传到服务器
    ↓
自动重启 Nginx
    ↓
✅ 部署完成！
```

### 手动部署流程

```
本地修改代码
    ↓
运行 ./deploy.sh
    ↓
本地构建项目
    ↓
SSH 连接服务器
    ↓
上传文件
    ↓
重启 Nginx
    ↓
✅ 部署完成！
```

---

## ⚙️ 核心配置文件说明

### 1. `.github/workflows/deploy.yml`

GitHub Actions 工作流配置文件，定义了自动部署的步骤。

**关键步骤**：
- 检出代码
- 安装依赖
- 构建项目
- 部署到服务器
- 重启 Nginx

### 2. `nginx.conf`

Nginx 配置文件，定义了 Web 服务器的行为。

**关键配置**：
- 监听 80 端口（HTTP）
- 支持 SPA 路由（`try_files`）
- Gzip 压缩
- 静态资源缓存
- SSL/HTTPS 配置（注释部分）

### 3. `deploy.sh`

手动部署脚本，自动化本地到服务器的部署过程。

**功能**：
- 自动构建项目
- 备份旧文件
- 上传新文件
- 设置权限
- 重启 Nginx

---

## 🌐 访问你的网站

部署完成后，通过以下方式访问：

### HTTP 访问
```
http://your-domain.com
或
http://your-server-ip
```

### HTTPS 访问（配置 SSL 后）
```
https://your-domain.com
```

---

## 🔒 HTTPS/SSL 配置（推荐）

### 使用 Let's Encrypt（免费）

```bash
# 1. 安装 Certbot
sudo apt install certbot python3-certbot-nginx -y

# 2. 获取证书（自动配置 Nginx）
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 3. 测试自动续期
sudo certbot renew --dry-run
```

**优势**：
- ✅ 完全免费
- ✅ 自动续期
- ✅ 自动配置 Nginx
- ✅ 受所有浏览器信任

---

## 📊 部署后验证

### 1. 检查网站是否可访问

```bash
# 测试 HTTP
curl http://your-domain.com

# 测试 HTTPS（如已配置）
curl https://your-domain.com
```

### 2. 检查 Nginx 状态

```bash
sudo systemctl status nginx
```

### 3. 查看 Nginx 日志

```bash
# 访问日志
sudo tail -f /var/log/nginx/mini-social-media-access.log

# 错误日志
sudo tail -f /var/log/nginx/mini-social-media-error.log
```

### 4. 测试应用功能

- [ ] 能否正常打开网站
- [ ] 能否注册新用户
- [ ] 能否登录
- [ ] 能否发布消息
- [ ] 能否编辑/删除消息
- [ ] 实时同步是否正常

---

## 🐛 常见问题

### ❓ GitHub Actions 部署失败

**检查项**：
1. GitHub Secrets 是否正确设置
2. 服务器 SSH 是否可访问
3. 查看 Actions 日志获取详细错误

**查看日志**：
```
GitHub 仓库 → Actions → 点击失败的 workflow → 查看步骤日志
```

### ❓ 网站显示 "Welcome to nginx!" 默认页面

**原因**：Nginx 默认站点优先级更高，覆盖了你的配置

**解决**：
```bash
# 删除默认站点
sudo rm /etc/nginx/sites-enabled/default

# 重启 Nginx
sudo systemctl restart nginx

# 强制刷新浏览器（重要！）
# Windows/Linux: Ctrl + Shift + R
# Mac: Cmd + Shift + R
```

**验证**：
```bash
# 检查启用的站点（应该只有 mini-social-media）
ls -la /etc/nginx/sites-enabled/
```

### ❓ 网站显示 403 Forbidden

**原因**：文件权限问题

**解决**：
```bash
sudo chown -R www-data:www-data /var/www/mini-social-media
sudo chmod -R 755 /var/www/mini-social-media
```

### ❓ 网站显示 502 Bad Gateway

**原因**：Nginx 配置错误或未启动

**解决**：
```bash
# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx

# 查看错误日志
sudo tail -f /var/log/nginx/error.log
```

### ❓ 修改代码后网站没更新

**GitHub Actions 部署**：
```bash
# 检查 Actions 是否成功运行
GitHub → Actions → 查看最新的 workflow

# 清除浏览器缓存
Ctrl + Shift + R (Chrome/Firefox)
```

**手动部署**：
```bash
# 重新运行部署脚本
./deploy.sh
```

### ❓ SSL 证书过期

**解决**：
```bash
# 手动续期
sudo certbot renew

# 重启 Nginx
sudo systemctl reload nginx
```

---

## 📈 进阶优化

### 1. 启用 HTTP/2

```nginx
# 在 nginx.conf 中
listen 443 ssl http2;
```

### 2. 配置 CDN

使用 Cloudflare、阿里云 CDN 等服务加速访问。

### 3. 监控和日志

安装监控工具：
```bash
# 安装 htop
sudo apt install htop

# 安装 nginx 日志分析工具
sudo apt install goaccess
```

### 4. 自动备份

创建备份脚本：
```bash
#!/bin/bash
tar -czf backup_$(date +%Y%m%d).tar.gz /var/www/mini-social-media
```

---

## 📞 获取帮助

遇到问题？参考以下资源：

1. **详细部署指南**：[DEPLOYMENT.md](./DEPLOYMENT.md)
2. **Nginx 官方文档**：https://nginx.org/en/docs/
3. **GitHub Actions 文档**：https://docs.github.com/en/actions
4. **Let's Encrypt 文档**：https://letsencrypt.org/docs/

---

## 🎉 部署成功检查清单

完成以下所有项即代表部署成功：

- [ ] ✅ Nginx 安装并运行正常
- [ ] ✅ 域名已解析到服务器 IP
- [ ] ✅ Nginx 配置已创建并启用
- [ ] ✅ 防火墙已开放相关端口
- [ ] ✅ SSL 证书已配置（可选）
- [ ] ✅ GitHub Secrets 已设置（自动部署）
- [ ] ✅ 网站可以正常访问
- [ ] ✅ 应用功能测试通过
- [ ] ✅ 部署流程已验证

---

## 🔄 更新部署

### GitHub Actions（自动）

```bash
# 只需提交并推送代码
git add .
git commit -m "Update feature"
git push origin main

# GitHub Actions 会自动部署
```

### 手动部署

```bash
# 运行部署脚本
./deploy.sh
```

---

## 💡 最佳实践

1. **使用 HTTPS**：保护用户数据安全
2. **定期备份**：防止数据丢失
3. **监控日志**：及时发现问题
4. **自动部署**：提高开发效率
5. **测试环境**：先在测试环境验证，再部署到生产环境

---

## 🎯 推荐部署配置

### 个人项目推荐

- **服务器**：腾讯云/阿里云 轻量应用服务器（1核2G）
- **部署方式**：GitHub Actions 自动部署
- **SSL 证书**：Let's Encrypt（免费）
- **域名**：购买一个便宜的域名（.com/.cn/.top 等）

### 成本估算

- 服务器：约 ¥50-100/月
- 域名：约 ¥30-100/年
- SSL 证书：免费（Let's Encrypt）
- **总计**：约 ¥600-1300/年

---

**祝你部署顺利！** 🚀

有任何问题请查看 [DEPLOYMENT.md](./DEPLOYMENT.md) 获取详细帮助。

